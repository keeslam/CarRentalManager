# CarRentalManager - NO npm warnings + juiste paden

[variables]
NIXPACKS_NODE_VERSION = "18"
NODE_ENV = "production"
PORT = "3000"

# Installatie: Unset NODE_ENV om npm warnings te voorkomen
[phases.install]
cmds = [
  "echo '=== INSTALLING DEPENDENCIES (NO WARNINGS) ==='",
  "NODE_ENV='' npm ci --omit=dev",     # Root: Unset NODE_ENV
  "cd client && NODE_ENV='' npm ci --omit=dev || echo 'Client install skipped'",  # Frontend
  "cd server && NODE_ENV='' npm ci --omit=dev || echo 'Server install skipped'",  # Backend
  "echo '✅ Dependencies installed - NO warnings!'"
]

# Build: Frontend + Backend + Copy naar server pad
[phases.build]
cmds = [
  "echo '=== BUILDING CAR RENTAL MANAGER ==='",
  "ls -la",
  
  # Frontend build (output naar root /dist/public/)
  "echo '--- Building Frontend ---'",
  "npm run build",  # Jouw root build script (vite + esbuild)
  
  # Backend build (als apart nodig)
  "echo '--- Backend bundling ---'",
  "cd server && npm run build 2>/dev/null || echo 'No separate server build'",
  "cd ..",
  
  # Copy frontend van /dist/public/ naar /dist/dist/public/ (server verwacht dit)
  "echo '--- Copy Frontend to /dist/dist/public (server expected path) ---'",
  "mkdir -p dist/dist/public",
  "cp -r dist/public/* dist/dist/public/ 2>/dev/null || echo 'No /dist/public/ found'",
  
  # Validate zonder if-statement
  "echo '--- Validating ---'",
  "test -f dist/dist/public/index.html && echo '✅ Frontend ready in /dist/dist/public' || echo '❌ No index.html in expected path'",
  "ls -la dist/dist/public/ 2>/dev/null || echo 'dist/dist/public is empty'",
  
  "echo '=== BUILD COMPLETE ==='"
]

# Start: Backend server
[start]
cmd = "npm start"
